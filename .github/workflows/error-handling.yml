name: Error Handling Demonstration

# Manual trigger only - allows choosing error scenarios
on:
  workflow_dispatch:
    inputs:
      error_type:
        description: 'Type of error to simulate'
        required: true
        type: choice
        options:
          - none
          - dependency
          - test
          - build
        default: 'none'
      recovery_strategy:
        description: 'Recovery strategy to demonstrate'
        required: true
        type: choice
        options:
          - fail-fast
          - continue-on-error
          - retry
        default: 'fail-fast'

jobs:
  # Job 1: Setup and display configuration
  setup:
    name: Display Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Show selected options
        run: |
          echo "ðŸŽ¯ Error Handling Demonstration"
          echo "================================"
          echo "Error Type: ${{ inputs.error_type }}"
          echo "Recovery Strategy: ${{ inputs.recovery_strategy }}"
          echo "================================"

  # Job 2: Dependency installation with error handling
  dependencies:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: ${{ inputs.recovery_strategy == 'continue-on-error' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Simulate dependency failure if selected
      - name: Install dependencies
        id: install
        run: |
          if [ "${{ inputs.error_type }}" = "dependency" ]; then
            echo "âŒ Simulating dependency installation failure..."
            echo "This would happen if package.json has invalid dependencies"
            exit 1
          else
            echo "âœ… Installing dependencies normally..."
            npm ci
          fi

      # Retry logic demonstration (only if retry strategy selected)
      - name: Retry installation on failure
        if: failure() && steps.install.outcome == 'failure' && inputs.recovery_strategy == 'retry'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "ðŸ”„ Retry attempt with fallback strategy..."
            echo "In real scenario: try alternative registry, clear cache, etc."
            npm ci

  # Job 3: Test execution with error handling
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: dependencies
    if: always() && (needs.dependencies.result == 'success' || inputs.recovery_strategy == 'continue-on-error')
    continue-on-error: ${{ inputs.recovery_strategy == 'continue-on-error' }}
    strategy:
      fail-fast: ${{ inputs.recovery_strategy == 'fail-fast' }}
      matrix:
        test-suite: [unit, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: needs.dependencies.result == 'success'
        run: npm ci

      # Simulate test failure if selected
      - name: Run ${{ matrix.test-suite }} tests
        id: test
        run: |
          if [ "${{ inputs.error_type }}" = "test" ] && [ "${{ matrix.test-suite }}" = "unit" ]; then
            echo "âŒ Simulating test failure in ${{ matrix.test-suite }} suite..."
            echo "This would happen if tests fail due to code issues"
            exit 1
          else
            echo "âœ… Running ${{ matrix.test-suite }} tests normally..."
            npm test
          fi

      # Retry logic for tests (only if retry strategy selected)
      - name: Retry tests on failure
        if: failure() && steps.test.outcome == 'failure' && inputs.recovery_strategy == 'retry'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          retry_wait_seconds: 5
          command: |
            echo "ðŸ”„ Retrying ${{ matrix.test-suite }} tests..."
            echo "In real scenario: tests might pass on retry due to flakiness"
            npm test

  # Job 4: Build with error handling
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [dependencies, tests]
    if: always() && (needs.dependencies.result == 'success' || inputs.recovery_strategy == 'continue-on-error')
    continue-on-error: ${{ inputs.recovery_strategy == 'continue-on-error' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: needs.dependencies.result == 'success'
        run: npm ci

      # Simulate build failure if selected
      - name: Build application
        id: build
        run: |
          if [ "${{ inputs.error_type }}" = "build" ]; then
            echo "âŒ Simulating build failure..."
            echo "This would happen if compilation/bundling fails"
            exit 1
          else
            echo "âœ… Building application normally..."
            npm run build
          fi

      # Retry logic for build (only if retry strategy selected)
      - name: Retry build on failure
        if: failure() && steps.build.outcome == 'failure' && inputs.recovery_strategy == 'retry'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          retry_wait_seconds: 5
          command: |
            echo "ðŸ”„ Retrying build with adjustments..."
            echo "In real scenario: clear build cache, adjust memory, etc."
            npm run build

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Job 5: Summary report
  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [setup, dependencies, tests, build]
    if: always()
    steps:
      - name: Generate detailed summary
        run: |
          echo "# ðŸ“Š Error Handling Demonstration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Type**: \`${{ inputs.error_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Recovery Strategy**: \`${{ inputs.recovery_strategy }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependencies.result }} | ${{ needs.dependencies.result == 'success' && 'âœ… Passed' || needs.dependencies.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.tests.result }} | ${{ needs.tests.result == 'success' && 'âœ… Passed' || needs.tests.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} | ${{ needs.build.result == 'success' && 'âœ… Passed' || needs.build.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Recovery Strategy Explanation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.recovery_strategy }}" = "fail-fast" ]; then
            echo "### Fail Fast âš¡" >> $GITHUB_STEP_SUMMARY
            echo "- Stops all running jobs immediately when one fails" >> $GITHUB_STEP_SUMMARY
            echo "- Saves CI/CD resources and time" >> $GITHUB_STEP_SUMMARY
            echo "- Best for: catching critical issues quickly" >> $GITHUB_STEP_SUMMARY
            echo "- Used in matrix strategies to stop other test suites" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.recovery_strategy }}" = "continue-on-error" ]; then
            echo "### Continue on Error ðŸ”„" >> $GITHUB_STEP_SUMMARY
            echo "- Allows workflow to proceed even if jobs fail" >> $GITHUB_STEP_SUMMARY
            echo "- Subsequent jobs can run with \`if: always()\`" >> $GITHUB_STEP_SUMMARY
            echo "- Best for: getting complete test results, non-critical failures" >> $GITHUB_STEP_SUMMARY
            echo "- Useful for informational checks that shouldn't block deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.recovery_strategy }}" = "retry" ]; then
            echo "### Retry Logic ðŸ”" >> $GITHUB_STEP_SUMMARY
            echo "- Automatically retries failed steps multiple times" >> $GITHUB_STEP_SUMMARY
            echo "- Configurable wait time between attempts" >> $GITHUB_STEP_SUMMARY
            echo "- Best for: flaky tests, network issues, temporary failures" >> $GITHUB_STEP_SUMMARY
            echo "- Reduces false negatives from transient problems" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Error Type Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.error_type }}" = "dependency" ]; then
            echo "**Dependency Failure**: Simulates npm install failures" >> $GITHUB_STEP_SUMMARY
            echo "- Common causes: invalid package versions, network issues, private registry problems" >> $GITHUB_STEP_SUMMARY
            echo "- Recovery options: retry with backoff, fallback registry, clear cache" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.error_type }}" = "test" ]; then
            echo "**Test Failure**: Simulates failing unit tests" >> $GITHUB_STEP_SUMMARY
            echo "- Common causes: code bugs, environment differences, flaky tests" >> $GITHUB_STEP_SUMMARY
            echo "- Recovery options: retry flaky tests, run in isolation, adjust timeouts" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.error_type }}" = "build" ]; then
            echo "**Build Failure**: Simulates compilation/build errors" >> $GITHUB_STEP_SUMMARY
            echo "- Common causes: syntax errors, missing dependencies, memory limits" >> $GITHUB_STEP_SUMMARY
            echo "- Recovery options: increase memory, clear build cache, adjust build config" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No Error**: All jobs should complete successfully" >> $GITHUB_STEP_SUMMARY
            echo "- This demonstrates the happy path through the pipeline" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This workflow demonstrates various error handling patterns in GitHub Actions*" >> $GITHUB_STEP_SUMMARY

      - name: Print summary to console
        run: |
          echo "================================"
          echo "ðŸ“Š WORKFLOW SUMMARY"
          echo "================================"
          echo "Error Type: ${{ inputs.error_type }}"
          echo "Recovery Strategy: ${{ inputs.recovery_strategy }}"
          echo ""
          echo "Job Results:"
          echo "  - Dependencies: ${{ needs.dependencies.result }}"
          echo "  - Tests: ${{ needs.tests.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "================================"
